"""
Documentation utilities for EDINET Data Getter
"""
import os
from datetime import datetime
from pathlib import Path
from typing import List, Dict, Any
from .config import config


def generate_run_summary(documents: List[Dict], processed_data: List[Dict], start_date: str) -> str:
    """Generate a markdown summary of the processing run"""
    
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    summary = f"""# EDINET Data Processing Summary

## Run Information
- **Date**: {timestamp}
- **Start Date**: {start_date}
- **Total Documents Found**: {len(documents)}
- **Successfully Processed**: {len(processed_data)}

## Processing Results

### Successfully Processed Companies
"""
    
    for i, data in enumerate(processed_data, 1):
        company_name = data.get('ä¼æ¥­å', 'Unknown')
        edinet_code = data.get('EDINETã‚³ãƒ¼ãƒ‰', 'N/A')
        summary += f"{i}. **{company_name}** (EDINET: {edinet_code})\n"
    
    summary += f"""
### Skipped Documents
Total skipped: {len(documents) - len(processed_data)}

## Configuration Used
- **XBRL Folder**: {config['xbrl_folder']}
- **JSON Folder**: {config['json_folder']}
- **Log Folder**: {config['log_folder']}
- **Company Count Limit**: {config['default_company_count']}

## Data Fields Extracted
- é…å½“æ€§å‘ (Dividend Payout Ratio)
- EPS (Earnings Per Share)
- æ ªä¾¡åŽç›ŠçŽ‡ (Price-to-Earnings Ratio)
- å–¶æ¥­CF (Operating Cash Flow)
- å–¶æ¥­åˆ©ç›ŠçŽ‡ (Operating Profit Margin)
- é…å½“åˆ©å›žã‚Š (Dividend Yield)
- è‡ªå·±è³‡æœ¬æ¯”çŽ‡ (Equity Ratio)

---
Generated by EDINET Data Getter on {timestamp}
"""
    
    return summary


def save_run_summary(documents: List[Dict], processed_data: List[Dict], start_date: str) -> Path:
    """Save the run summary to a markdown file"""
    
    summary_content = generate_run_summary(documents, processed_data, start_date)
    
    # Create filename with timestamp
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"run_summary_{start_date}_{timestamp}.md"
    filepath = config['md_folder'] / filename
    
    # Ensure directory exists
    config['md_folder'].mkdir(exist_ok=True)
    
    # Write summary
    with open(filepath, 'w', encoding='utf-8') as f:
        f.write(summary_content)
    
    return filepath


def generate_config_documentation() -> str:
    """Generate technical documentation index for the md folder"""
    
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    doc = f"""# Technical Documentation | æŠ€è¡“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

## ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªž

ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ã¯ã€EDINET Data Getterã®æŠ€è¡“çš„ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§
- [config.md](config.md) - è¨­å®šã‚¬ã‚¤ãƒ‰ï¼ˆç’°å¢ƒå¤‰æ•°ã€èªè¨¼æƒ…å ±ã®è¨­å®šæ–¹æ³•ï¼‰
- [processing_flow.md](processing_flow.md) - å‡¦ç†ãƒ•ãƒ­ãƒ¼ã®è©³ç´°èª¬æ˜Ž
- å‡¦ç†çµæžœãƒ¬ãƒãƒ¼ãƒˆï¼ˆå®Ÿè¡Œæ™‚ã«è‡ªå‹•ç”Ÿæˆï¼‰

### è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ï¼š
- `run_summary_YYYY-MM-DD_HHMMSS.md` - å„å®Ÿè¡Œã®çµæžœã‚µãƒžãƒªãƒ¼

---

## ðŸ‡ºðŸ‡¸ English

This folder contains technical documentation for EDINET Data Getter.

### Document List
- [config.md](config.md) - Configuration guide (environment variables, authentication setup)
- [processing_flow.md](processing_flow.md) - Detailed processing flow explanation
- Processing result reports (automatically generated during execution)

### Auto-generated Files
The following files are automatically generated during execution:
- `run_summary_YYYY-MM-DD_HHMMSS.md` - Result summary for each execution

---

## ðŸ“Š Current Configuration Summary

- **Company Count Limit**: {config['default_company_count']}
- **Default Start Date**: {config['default_start_date']}
- **Sheet Name**: {config['sheet_name']}
- **JSON Folder**: {config['json_folder']}
- **Log Folder**: {config['log_folder']}
- **MD Folder**: {config['md_folder']}
- **XBRL Folder**: {config['xbrl_folder']}

## ðŸ’¾ Extracted Data Fields
- é…å½“æ€§å‘ (Dividend Payout Ratio)
- EPS (Earnings Per Share)
- æ ªä¾¡åŽç›ŠçŽ‡ (Price-to-Earnings Ratio)
- å–¶æ¥­CF (Operating Cash Flow)
- å–¶æ¥­åˆ©ç›ŠçŽ‡ (Operating Profit Margin)
- é…å½“åˆ©å›žã‚Š (Dividend Yield)
- è‡ªå·±è³‡æœ¬æ¯”çŽ‡ (Equity Ratio)

---
Last updated: {timestamp}
"""
    
    return doc


def save_config_documentation() -> Path:
    """Save the configuration documentation"""
    
    doc_content = generate_config_documentation()
    filepath = config['md_folder'] / "README.md"
    
    # Ensure directory exists
    config['md_folder'].mkdir(exist_ok=True)
    
    with open(filepath, 'w', encoding='utf-8') as f:
        f.write(doc_content)
    
    return filepath